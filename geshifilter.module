<?php

/**
 * @file
 * An input filter for syntax highlighting using the GeSHi library.
 */

define('GESHIFILTER_DEFAULT_PLAINTEXT', 'GESHIFILTER_DEFAULT_PLAINTEXT');
define('GESHIFILTER_DEFAULT_DONOTHING', 'GESHIFILTER_DEFAULT_DONOTHING');

// GeSHi CSS modes
// Inline CSS.
define('GESHIFILTER_CSS_INLINE', 1);
// Usage of CSS classes and an automatically managaged external stylesheet.
define('GESHIFILTER_CSS_CLASSES_AUTOMATIC', 2);
// Only add CSS classes to markup, admin/themer is responsible for defining the
// CSS rules.
define('GESHIFILTER_CSS_CLASSES_ONLY', 3);

define('GESHIFILTER_ATTRIBUTES_LANGUAGE', 'type lang language class');
define('GESHIFILTER_ATTRIBUTE_LINE_NUMBERING', 'linenumbers');
define('GESHIFILTER_ATTRIBUTE_LINE_NUMBERING_START', 'start');
define('GESHIFILTER_ATTRIBUTE_FANCY_N', 'fancy');
define('GESHIFILTER_ATTRIBUTE_TITLE', 'title');

define('GESHIFILTER_BRACKETS_ANGLE', 1);
define('GESHIFILTER_BRACKETS_SQUARE', 2);
// Deprecated, only used in upgrade path.
define('GESHIFILTER_BRACKETS_BOTH', 3);
define('GESHIFILTER_BRACKETS_DOUBLESQUARE', 4);
define('GESHIFILTER_BRACKETS_PHPBLOCK', 8);


define('GESHIFILTER_LINE_NUMBERS_DEFAULT_NONE', 0);
define('GESHIFILTER_LINE_NUMBERS_DEFAULT_NORMAL', 1);
define('GESHIFILTER_LINE_NUMBERS_DEFAULT_FANCY5', 5);
define('GESHIFILTER_LINE_NUMBERS_DEFAULT_FANCY10', 10);
define('GESHIFILTER_LINE_NUMBERS_DEFAULT_FANCY20', 20);

// Necessary for URL.
use Drupal\Core\Url;

use \Drupal\geshifilter\GeshiFilterCss;

/**
 * Implements hook_help().
 */
function geshifilter_help($path, $arg) {
  $config = \Drupal::config('geshifilter.settings');
  switch ($path) {
    case 'admin/config/content/formats/geshifilter':
    case 'admin/help#geshifilter':
      $output = '<p>' . t('The GeSHi filter module provides a filter for syntax
        highlighting of inline source code or blocks of source code based on the
        PHP library !GeSHi.', array(
          '!GeSHi' => \Drupal::l('GeSHi (Generic Syntax Highlighter)', URL::fromUri('http://qbnz.com/highlighter/'))))
        . '</p>';
      if ($path == 'admin/help#geshifilter') {
        $output .= '<p>' . t('The GeSHi filter module for Drupal requires the
          GeSHi library (version 1.0.x) to work. The GeSHi filter is actually
          just a Drupal wrapper module around the GeSHi library. Because of
          <a href="!repositorypolicies">drupal.org repository policies</a>
          however, the GeSHi library is not included in the GeSHi filter
          package, so you should <a href="!geshi">download</a> and install the
          GeSHi library separately.', array(
            '!repositorypolicies' => URL::fromUri('http://drupal.org/node/66113')->toString(),
            '!geshi' => URL::fromUri('http://qbnz.com/highlighter/')->toString(),
          ))
          . '</p>';
        $output .= t('<p>Quick overview of how to set up and use the GeSHi filter:</p><ul><li>Install the GeSHi library and specify its path on the <a href="!geshifilter_settings">GeSHi filter administration page</a>.</li><li>Configure the <a href="!geshifilter_settings">general GeSHi filter settings</a>.</li><li><a href="!geshifilter_languages">Enable the relevant languages</a> for your site and set their language tags if needed.</li><li>Enable the GeSHi filter in the desired !inputformats.</li><li>Check for !filterconflicts and resolve them.</li><li>Use the text format during content submission as described in the !filtertips.</li></ul>', array(
          '!geshifilter_settings' => URL::fromRoute('geshifilter.settings')->toString(),
          '!geshifilter_languages' => URL::fromRoute('geshifilter.settings_languages_all')->toString(),
          '!inputformats' => \Drupal::l('text formats', URL::fromRoute('filter.admin_overview')),
          '!filterconflicts' => \Drupal::l('filter conflicts', URL::fromRoute('geshifilter.settings_filter_conflicts')),
          '!filtertips' => \Drupal::l('filter tips', URL::fromRoute('filter.tips_all')),
        ));
      }
      return $output;

    case 'admin/config/content/formats/geshifilter/languages':
    case 'admin/config/content/formats/geshifilter/languages/enabled':
    case 'admin/config/content/formats/geshifilter/languages/all':
    case 'admin/config/content/formats/geshifilter/languages/disabled':
      $output = '<p>' . t('Here you can enable/disable the desired languages to
        use. It is suggested to disable languages that are not relevant for you
        site not only to avoid unnecessary cluttering of the GeSHi filter
        configuration pages and the !filtertips, but also to make the GeSHi
        filter processing lighter.', array(
          '!filtertips' => \Drupal::l('filter tips', URL::fromRoute('filter.tips_all'))))
        . '</p>';
      if (!$config->get('format_specific_options', FALSE)) {
        $output .= '<p>' . t('You can also define the language specific tags here.') . '</p>';
      }
      return $output;
  }
}

/**
 * Prepare callback for the GeSHi filter.
 */
function geshifilter_prepare_callback($text, $filter) {
  require_once drupal_get_path('module', 'geshifilter') . '/geshifilter.pages.inc';
  return _geshifilter_prepare($filter->format, $text);
}

/**
 * Implements hook_libraries_info().
 */
function geshifilter_libraries_info() {
  return array(
    'geshi' => array(
      'title' => 'GeSHi - Generic Syntax Highlighter for PHP',
      'vendor url' => 'http://sourceforge.net/projects/geshi',
      'download url' => 'http://sourceforge.net/projects/geshi/files/geshi',
      'version arguments' => array(
        'file' => 'geshi.php',
        'pattern' => "/define\('GESHI_VERSION', '(.*)'\);/",
        'lines' => 50,
      ),
      'files' => array(
        'php' => array(
          'geshi.php',
        ),
      ),
    ),
  );
}

